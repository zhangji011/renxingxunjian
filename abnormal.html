<!DOCTYPE html>
<html>
  <head>
    <meta charset=UTF-8>
    <meta name=viewport content="width=device-width,initial-scale=1,user-scalable=0">
    <title>商户异常</title>
    <link rel="stylesheet" href="static/weui.min.css">
    <style>
      body,html{height:100%;background-color:#f8f8f8}body{font-family:-apple-system-font,Helvetica Neue,Helvetica,sans-serif}.item{padding:0.625rem 0}.item__title{margin-bottom:0.3125rem;padding-left:0.9375rem;padding-right:0.9375rem;color:#999;font-weight:400;font-size:0.875rem}.item__ctn{padding:0 0.9375rem}.page_feedback{padding:0.9375rem;overflow:auto;background-color:#FFF}label>*{pointer-events:none}.weui-picker__item{padding:0;height:2.125rem;line-height:2.125rem}.weui-navbar__item{height:3.125rem;line-height:3.125rem;padding-right: 3.125rem;font-size:1.125rem;}.icon{float:left;width:3.125rem;height:100%;text-align:left;background-image:url(static/img/left_back.png);background-repeat:no-repeat;background-position:0.375rem 50%;background-size:1.4rem;}
      .reason{
        position: relative;
        display: inline-block;
        width: 7rem;border: 1px solid #6d6565;
        text-align: center;
        border-radius: 5px;
        padding-right: 1rem;
        overflow: hidden; /*自动隐藏文字*/
        text-overflow: ellipsis;/*文字隐藏后添加省略号*/
        white-space: nowrap;/*强制不换行*/
        vertical-align: top;   /* 处理水平对齐问题 */
      }
      .reason:after{
        position: absolute;
        content: '';
        right: 0.3rem;
        margin-top: -0.25rem;
        top:50%;
        width: 0;
        height: 0;
        border-width: .5rem;
        border-style: solid;
        border-color:#6d6565 transparent transparent transparent;
      }
      .anormalbox{
        display: none;
      }
      .abnormaldetail{
        border: none;
        border-bottom: 1px solid #000;
        outline: none;
        text-indent: 5px;
      }
    </style>
  </head>

  <body ontouchstart>
    <p id=bear></p>
    <div class=weui-tab id=tab>
      <div class=weui-navbar>
        <div class="weui-navbar__item">
          <span onclick="JavaScript:history.go(-1);" class="icon"></span>
          <span>商户异常</span>
        </div>
        <!-- <div class=weui-navbar__item>上传</div> -->
      </div>
      <div class=weui-tab__panel>
        <div class=weui-tab__content>
          <form id="form" enctype="multipart/form-data" onsubmit="return false;">
            <div class="weui-cells weui-cells_form">

              <div class="weui-cells weui-cells_form" id=uploaderCustom1>
                <div class=weui-cell>
                  <div class=weui-cell__bd>
                    <div class=weui-uploader>
                      <div class=weui-uploader__hd>
                        <p class=weui-uploader__title>
                          <span style="color:red;"> *必传：</span>
                          异常原因：<span class="reason" id="reason">请选择原因</span>
                                   <span id="reasonId" style="display: none;">-1</span>
                        </p>
                        <!-- <div class=weui-uploader__info>
                          <span id=uploadCount1></span></div> -->
                      </div>
                      <!-- 选择其他显示 -->
                      <div class="anormalbox" id="anormalbox">
                        <div class=weui-uploader__hd>
                          <p class=weui-uploader__title>
                            <span style="color:red;"> *必传：</span>
                            异常详情：<input type="text" class="abnormaldetail" id="abnormaldetail"/>
                          </p>
                          <!-- <div class=weui-uploader__info> -->
                            <!-- <span id=uploadCount1></span></div> -->
                        </div>
                      </div>
                      <div class=weui-uploader__hd>
                        <p class=weui-uploader__title>
                          <span style="color:red;"> *必传：</span>
                          门头照片
                        </p>
                        <div class=weui-uploader__info>
                          <span id=uploadCount1></span></div>
                      </div>
                    </div>
                    <div class=weui-uploader__bd>
                      <ul class=weui-uploader__files id=uploaderCustomFiles1></ul>
                      <div class=weui-uploader__input-box>
                        <input name="pictureFile" id=uploaderCustomInput class=weui-uploader__input type=file accept=image/*
                          multiple=""></div>
                    </div>
                    <div>注意：请上传临近商户照片</div>
                  </div>
                </div>
              </div>
            </div>

            <input id="images" name="images" type="hidden">

            <div class=weui-btn-area>
              <a id=formSubmitBtn href="javascript:subReg();" class="weui-btn weui-btn_primary">提交</a>
            </div>
        </div>

        </form>
      </div>
    </div>
    </div>
    <script type="text/javascript" src="static/example.js"></script>
    <!-- <script src="https://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script> -->
    <script type="text/javascript" src="static/jquery.min.js"></script>
    <script type="text/javascript" src="static/weui.min.js"></script>
  </body>
  <script>
    window.onload = function() {
      var reason = document.getElementById("reason"); //异常原因文字描述
      var reasonId = document.getElementById("reasonId"); //异常原因 0  1  2
      var abnormaldetail = document.getElementById("abnormaldetail"); //异常原因输入框
      var anormalbox = document.getElementById("anormalbox");  //异常原因div
      reason.onclick = function() {
        weui.confirm(
          `<div style="font-size:14px;color:#000;"class="weui-cells weui-cells_radio">
              <label style="font-size:14px;padding:16px;"class="weui-cell weui-check__label"for=r1>
                关门或装修<div class=weui-cell__ft><input required type=radio class=weui-check name=sex value=0 id=r1 tips=请选择>
                <span class=weui-icon-checked></span></div>
              </label>
              <label class="weui-cell weui-check__label"for=r2>
                资料被盗用<div class=weui-cell__ft><input type=radio name=sex class=weui-check value=1 id=r2>
                <span class=weui-icon-checked></span></div>
              </label>
              <label class="weui-cell weui-check__label"for=r3>
                其他<div class=weui-cell__ft>
                  <input type=radio name=sex class=weui-check value=2 id=r3><span class=weui-icon-checked></span></div>
              </label>
          </div>`, {
            title: '请选择异常原因',
            buttons: [{
              label: '取消',
              type: 'default',
              onClick: function() {
              }
            }, {
              label: '确定',
              type: 'primary',
              onClick: function() {
                let item = null,
                   obj = document.getElementsByName("sex");
                for (let i = 0; i < obj.length; i++) { //遍历Radio
                  if (obj[i].checked) {
                    item = obj[i].value;
                  }
                }
                if(item==0){
                  reason.innerText="关门或维修";
                  anormalbox.style.display="none";
                  reasonId.innerText=0;
                }else if(item==1){
                  reason.innerText="资料被盗用";
                  anormalbox.style.display="none";
                  reasonId.innerText=1;
                }else if(item==2){
                  reason.innerText="其他";
                  anormalbox.style.display="block";
                  reasonId.innerText=2;
                }
              }
            }]
          });
      }
    }
    /* *
     * 确认提交信息(VM)
     * */
    var imagesIds = "";
    var imgStatus1 = "",    //门头照片   1 表示已有图片
      imgStatus2 = "",      //物料照片   1 表示已有图片
      imgStatus3 = "";     //交易截图    1 表示已有图片

    function GetQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg); //获取url中"?"符后的字符串并正则匹配
      var context = "";

      if (r != null)
        context = r[2];
      reg = null;
      r = null;
      return context == null || context == "" || context == "undefined" ? "" : context;
    }

    function subReg() {
      // console.log(GetQueryString("userId"));
      // console.log($("#images").val())
      // 验证参数值
      $("#images").val(imagesIds);  //图片ID  格式 ,106,107,108
      console.log(reasonId.innerText)
      if(reasonId.innerText == -1){
        weui.alert('请选择异常原因');
        return;
      }
      if(reasonId.innerText == 2 && !abnormaldetail.value){
        weui.alert('异常详情不能为空');
        return;
      }
      var params ={
        userId: GetQueryString("userId"),
        merId: GetQueryString('merId'),
        statusType:window.location.href.split('statusType=')[1],
        imagesId: $("#images").val(),
        erroReason:reasonId.innerText
      }
      var params1 ={
        userId: GetQueryString("userId"),
        merId: GetQueryString('merId'),
        statusType:0,
        imagesId: $("#images").val(),
        erroReason:reasonId.innerText
      }
      if(reasonId.innerText == 2){
        params.erroDesc=abnormaldetail.value;
        params1.erroDesc=abnormaldetail.value;
      }
      // return;
      if (imgStatus1 == 1) {
        $.ajax({
          type: "POST",
          // url: "http://113.108.79.80:3020/RHXJServer/merchantXj/uploadInfo",  //本地
          // url: "https://hbtest.letshappy.cn/RHXJServer/merchantXj/uploadInfo", //测试
          url: "https://find.cmpay.com:9102/RHXJServer/merchantXj/uploadInfo",  //投产
          async: false,
          // data: $("#form").serialize(),
          data: params,
          dataType: "json",
          success: function(d) {
            console.log(this.data);
            if (d.code == '0') {
              var loading = weui.loading('提交中...');
              setTimeout(function() {
                loading.hide();
                weui.toast('提交成功', 2000);
              }, 1500);
              // setTimeout("JavaScript:history.go(-2)", 2000);  //本地
              // setTimeout("javascript:location.href='https://hbtest.letshappy.cn/rhxj/main.html#/home1'", 2000);  //测试
              setTimeout("javascript:location.href='https://find.cmpay.com:9102/hebao/rhxj/main.html#/home1'", 2000);  //投产
            } else if (d.code == '-1') {
              weui.alert('该终端已由其他人员维护，请勿重复提交');
            } else {
              weui.confirm('该终端数据已录入，是否覆盖', {
                title: '提示',
                buttons: [{
                  label: '取消',
                  type: 'default',
                  onClick: function() {
                    console.log('no')
                  }
                }, {
                  label: '确定',
                  type: 'primary',
                  onClick: function() {
                    console.log('yes');
                    $.ajax({
                      type: "POST",
                      // url: "http://113.108.79.80:3020/RHXJServer/merchantXj/uploadInfo", //本地
                      // url: "https://hbtest.letshappy.cn/RHXJServer/merchantXj/uploadInfo", //测试
                      url: "https://find.cmpay.com:9102/RHXJServer/merchantXj/uploadInfo",  //投产
                      async: false,
                      // data: $("#form").serialize(),
                      data: params1,
                      dataType: "json",
                      success: function(d) {
                        setTimeout(function() {
                          weui.toast('提交成功', 1500);
                          // setTimeout("JavaScript:history.go(-2)", 2000);  //本地
                          // setTimeout("javascript:location.href='https://hbtest.letshappy.cn/rhxj/main.html#/home1'", 2000); //测试
                          setTimeout("javascript:location.href='https://find.cmpay.com:9102/hebao/rhxj/main.html#/home1'", 2000); //投产
                        }, 1500);
                      }
                    });
                  }
                }]
              });
            }
          }
        });
      } else {
        weui.alert('请上传商户门头照');
      }
    };
  </script>
</html>
